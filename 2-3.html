<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°è§†é¢‘æ’­æ”¾ - æ—¶é—´æˆ³+è¯­éŸ³è½¬æ–‡å­—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx-js.bundle.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4D7C0F',
                        secondary: '#65A30D',
                        light: '#F5F7E9',
                        lighter: '#F9FAF0',
                        dark: '#365314',
                        border: '#D4D9BE',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-thin { scrollbar-width: thin; }
            .scrollbar-thumb-rounded { scrollbar-color: rgba(77, 124, 15, 0.3) transparent; }
            .backdrop-blur { backdrop-filter: blur(8px); }
        }
    </style>
</head>
<body class="bg-light text-dark min-h-screen font-sans">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-light/90 backdrop-blur border-b border-border shadow-sm py-3 px-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-play-circle text-primary text-2xl"></i>
                <h1 class="text-xl font-bold">æœ¬åœ°è§†é¢‘æ’­æ”¾ç³»ç»Ÿ</h1>
            </div>
            <span class="text-sm text-primary/80">æ—¶é—´æˆ³ç®¡ç† | è¯­éŸ³è½¬æ–‡å­—å¯¼å‡ºWord</span>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        <!-- è§†é¢‘æ’­æ”¾åŒº -->
        <section class="lg:w-2/3">
            <div class="bg-lighter rounded-xl shadow-lg border border-border overflow-hidden">
                <div class="relative pt-[56.25%] bg-black">
                    <video id="videoPlayer" class="absolute inset-0 w-full h-full object-contain" controls></video>
                </div>
                <div class="p-4 flex flex-wrap gap-3 items-center justify-between">
                    <div class="flex gap-3">
                        <label for="videoFile" class="cursor-pointer bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fa fa-film"></i>é€‰æ‹©è§†é¢‘
                        </label>
                        <input type="file" id="videoFile" accept="video/*" class="hidden">
                        
                        <button id="addTimestamp" class="bg-secondary hover:bg-secondary/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition opacity-50 cursor-not-allowed" disabled>
                            <i class="fa fa-plus-circle"></i>æ·»åŠ æ—¶é—´æˆ³
                        </button>

                        <!-- è¯­éŸ³è¯†åˆ«å¯åœæŒ‰é’® -->
                        <button id="toggleRecog" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition opacity-50 cursor-not-allowed" disabled>
                            <i class="fa fa-microphone"></i>å¯åŠ¨è¯­éŸ³è¯†åˆ«
                        </button>
                    </div>
                    <div class="text-sm text-dark/70" id="videoInfo">æœªé€‰æ‹©è§†é¢‘ | éœ€Chrome/Edgeæµè§ˆå™¨+éº¦å…‹é£æƒé™</div>
                </div>
            </div>
        </section>

        <!-- å³ä¾§åŠŸèƒ½åŒºï¼šæ—¶é—´æˆ³ + è¯­éŸ³è½¬æ–‡å­— -->
        <div class="lg:w-1/3 flex flex-col gap-6">
            <!-- æ—¶é—´æˆ³åŒºåŸŸ -->
            <div class="bg-lighter rounded-xl shadow-lg border border-border flex flex-col h-full">
                <div class="p-4 border-b border-border flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa fa-list-alt text-primary"></i>æ—¶é—´æˆ³åˆ—è¡¨
                    </h2>
                    <div class="flex gap-2">
                        <button id="exportTs" class="p-2 rounded-lg text-dark/70 hover:text-primary hover:bg-primary/10 transition opacity-50 cursor-not-allowed" disabled title="å¯¼å‡ºæ—¶é—´æˆ³">
                            <i class="fa fa-download"></i>
                        </button>
                        <button id="clearTs" class="p-2 rounded-lg text-dark/70 hover:text-primary hover:bg-primary/10 transition opacity-50 cursor-not-allowed" disabled title="æ¸…ç©ºæ—¶é—´æˆ³">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div id="tsList" class="flex-grow overflow-y-auto p-3 scrollbar-thin scrollbar-thumb-rounded">
                    <div class="text-dark/50 flex flex-col items-center justify-center h-48">
                        <i class="fa fa-clock-o text-4xl mb-3 opacity-30 text-primary/60"></i>
                        <p class="text-center">æ’­æ”¾è§†é¢‘æ—¶æ·»åŠ æ—¶é—´æˆ³</p>
                    </div>
                </div>
                <div class="p-4 border-t border-border bg-light/50 text-sm">
                    <div class="flex justify-between">
                        <span>å½“å‰æ—¶é—´: <span id="currTime" class="text-primary font-medium">00:00:00</span></span>
                        <span>æ€»æ•°: <span id="tsCount" class="text-primary font-medium">0</span></span>
                    </div>
                </div>
            </div>

            <!-- è¯­éŸ³è½¬æ–‡å­—åŒºåŸŸï¼ˆæ—¶é—´æˆ³ä¸‹æ–¹ï¼‰ -->
            <div class="bg-lighter rounded-xl shadow-lg border border-border flex flex-col h-full">
                <div class="p-4 border-b border-border flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa fa-microphone text-primary"></i>è§†é¢‘è¯­éŸ³æ–‡å­—
                    </h2>
                    <div class="flex gap-2">
                        <!-- å¯¼å‡ºWordæŒ‰é’® -->
                        <button id="exportWord" class="p-2 rounded-lg text-dark/70 hover:text-primary hover:bg-primary/10 transition opacity-50 cursor-not-allowed" disabled title="å¯¼å‡ºWord">
                            <i class="fa fa-file-word-o text-lg"></i>
                        </button>
                        <!-- æ¸…ç©ºæ–‡å­—æŒ‰é’® -->
                        <button id="clearText" class="p-2 rounded-lg text-dark/70 hover:text-primary hover:bg-primary/10 transition opacity-50 cursor-not-allowed" disabled title="æ¸…ç©ºæ–‡å­—">
                            <i class="fa fa-trash text-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-grow p-4">
                    <textarea id="speechText" class="w-full h-full bg-light border border-border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 scrollbar-thin resize-none" placeholder="è¯­éŸ³è¯†åˆ«çš„æ–‡å­—ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ”¯æŒæ‰‹åŠ¨ç¼–è¾‘..."></textarea>
                </div>
                <div class="p-4 border-t border-border bg-light/50 text-sm flex justify-between items-center">
                    <span id="recogStatus" class="text-dark/50">æœªå¼€å§‹è¯†åˆ« | ä»…æ”¯æŒChrome/Edge</span>
                    <span>å­—ç¬¦æ•°: <span id="charCount" class="text-primary font-medium">0</span></span>
                </div>
            </div>
        </div>
    </main>

    <!-- æ—¶é—´æˆ³æ¨¡æ€æ¡† -->
    <div id="tsModal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-lighter rounded-xl shadow-xl w-full max-w-md border border-border transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-border flex justify-between items-center">
                <h3 class="text-lg font-semibold text-primary">æ·»åŠ æ—¶é—´æˆ³</h3>
                <button id="closeModal" class="text-dark/50 hover:text-dark cursor-pointer"><i class="fa fa-times"></i></button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark/70 mb-1">æ—¶é—´ç‚¹</label>
                    <input type="text" id="tsTime" class="w-full bg-light border border-border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30" readonly>
                </div>
                <div class="mb-5">
                    <label class="block text-sm font-medium text-dark/70 mb-1">æè¿°</label>
                    <input type="text" id="tsDesc" class="w-full bg-light border border-border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="è¾“å…¥è¯¥æ—¶é—´ç‚¹çš„æè¿°...">
                </div>
                <button id="saveTs" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition">ä¿å­˜æ—¶é—´æˆ³</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ -->
    <footer class="mt-6 border-t border-border py-4 px-4 text-center text-dark/60 text-sm">
        <p>æœ¬åœ°è§†é¢‘æ’­æ”¾ç³»ç»Ÿ | ä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½ | è¯­éŸ³è½¬æ–‡å­—éœ€å¤–æ”¾è§†é¢‘å£°éŸ³å¹¶å¼€å¯éº¦å…‹é£</p>
    </footer>

    <script>
        // ========== åŸºç¡€DOMå…ƒç´  ==========
        const videoPlayer = document.getElementById('videoPlayer');
        const videoFile = document.getElementById('videoFile');
        const videoInfo = document.getElementById('videoInfo');
        // æ—¶é—´æˆ³ç›¸å…³
        const addTimestamp = document.getElementById('addTimestamp');
        const tsList = document.getElementById('tsList');
        const currTime = document.getElementById('currTime');
        const tsCount = document.getElementById('tsCount');
        const exportTs = document.getElementById('exportTs');
        const clearTs = document.getElementById('clearTs');
        const tsModal = document.getElementById('tsModal');
        const closeModal = document.getElementById('closeModal');
        const saveTs = document.getElementById('saveTs');
        const tsTime = document.getElementById('tsTime');
        const tsDesc = document.getElementById('tsDesc');
        // è¯­éŸ³è¯†åˆ«ç›¸å…³
        const toggleRecog = document.getElementById('toggleRecog');
        const speechText = document.getElementById('speechText');
        const exportWord = document.getElementById('exportWord');
        const clearText = document.getElementById('clearText');
        const recogStatus = document.getElementById('recogStatus');
        const charCount = document.getElementById('charCount');
        // è¯­éŸ³è¯†åˆ«æ ¸å¿ƒå¯¹è±¡
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isRecogRunning = false; // è¯†åˆ«æ˜¯å¦è¿è¡Œ
        let finalText = ''; // æœ€ç»ˆè¯†åˆ«æ–‡å­—
        // æ—¶é—´æˆ³æ•°æ®
        let tsData = [];

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            // è§†é¢‘é€‰æ‹©äº‹ä»¶
            videoFile.addEventListener('change', loadVideo);
            // è§†é¢‘æ—¶é—´æ›´æ–°
            videoPlayer.addEventListener('timeupdate', updateVideoTime);
            // æ—¶é—´æˆ³æŒ‰é’®äº‹ä»¶
            addTimestamp.addEventListener('click', openTsModal);
            closeModal.addEventListener('click', closeTsModal);
            saveTs.addEventListener('click', saveTimestamp);
            exportTs.addEventListener('click', exportTimestamp);
            clearTs.addEventListener('click', clearAllTimestamp);
            // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            tsModal.addEventListener('click', e => e.target === tsModal && closeTsModal());
            // è¯­éŸ³ç›¸å…³äº‹ä»¶
            initSpeechRecog(); // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            toggleRecog.addEventListener('click', switchRecog); // å¯åœè¯†åˆ«
            exportWord.addEventListener('click', exportToWord); // å¯¼å‡ºWord
            clearText.addEventListener('click', clearSpeechText); // æ¸…ç©ºæ–‡å­—
            speechText.addEventListener('input', updateCharCount); // æ›´æ–°å­—ç¬¦æ•°
        });

        // ========== è§†é¢‘ç›¸å…³åŠŸèƒ½ ==========
        // åŠ è½½è§†é¢‘
        function loadVideo(e) {
            const file = e.target.files[0];
            if (!file) return;
            const videoUrl = URL.createObjectURL(file);
            videoPlayer.src = videoUrl;
            videoInfo.textContent = `${file.name} (${formatFileSize(file.size)}) | æ’­æ”¾åå¯æ·»åŠ æ—¶é—´æˆ³/å¯åŠ¨è¯­éŸ³è¯†åˆ«`;
            // å¯ç”¨æ‰€æœ‰æŒ‰é’®
            [addTimestamp, exportTs, clearTs, toggleRecog].forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            // é‡ç½®æ—¶é—´æˆ³
            tsData = [];
            renderTsList();
        }

        // æ›´æ–°è§†é¢‘å½“å‰æ—¶é—´æ˜¾ç¤º
        function updateVideoTime() {
            currTime.textContent = formatSecToTime(videoPlayer.currentTime);
        }

        // æ ¼å¼åŒ–ç§’æ•°ä¸º HH:MM:SS
        function formatSecToTime(sec) {
            const h = Math.floor(sec / 3600).toString().padStart(2, '0');
            const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(sec % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // ========== æ—¶é—´æˆ³æ¨¡æ€æ¡† ==========
        function openTsModal() {
            const time = formatSecToTime(videoPlayer.currentTime);
            tsTime.value = time;
            tsDesc.value = '';
            tsDesc.focus();
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            tsModal.classList.remove('hidden');
            setTimeout(() => {
                tsModal.classList.add('opacity-100');
                tsModal.querySelector('div').classList.remove('scale-95');
                tsModal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeTsModal() {
            tsModal.classList.remove('opacity-100');
            tsModal.querySelector('div').classList.remove('scale-100');
            tsModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => tsModal.classList.add('hidden'), 300);
        }

        // ========== æ—¶é—´æˆ³å¢åˆ æ”¹æŸ¥ ==========
        function saveTimestamp() {
            const time = videoPlayer.currentTime;
            const formatTime = formatSecToTime(time);
            const desc = tsDesc.value.trim() || `æ—¶é—´ç‚¹ ${tsData.length + 1}`;
            // æ·»åŠ æ•°æ®
            tsData.push({ id: Date.now(), time, formatTime, desc });
            // æ’åºå¹¶æ¸²æŸ“
            tsData.sort((a, b) => a.time - b.time);
            renderTsList();
            // å…³é—­æ¨¡æ€æ¡†
            closeTsModal();
        }

        // æ¸²æŸ“æ—¶é—´æˆ³åˆ—è¡¨
        function renderTsList() {
            if (tsData.length === 0) {
                tsList.innerHTML = `
                    <div class="text-dark/50 flex flex-col items-center justify-center h-48">
                        <i class="fa fa-clock-o text-4xl mb-3 opacity-30 text-primary/60"></i>
                        <p class="text-center">æš‚æ— æ—¶é—´æˆ³<br>æ’­æ”¾è§†é¢‘æ—¶æ·»åŠ </p>
                    </div>
                `;
                tsCount.textContent = '0';
                return;
            }
            tsList.innerHTML = '';
            tsData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-light hover:bg-primary/5 border border-border rounded-lg p-3 mb-2 cursor-pointer transition flex justify-between items-center group';
                div.dataset.id = item.id;
                div.dataset.time = item.time;
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-primary">${item.formatTime}</div>
                        <div class="text-sm text-dark/70 mt-1">${item.desc}</div>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button class="edit-ts p-1 hover:text-primary" title="ç¼–è¾‘"><i class="fa fa-pencil"></i></button>
                        <button class="del-ts p-1 hover:text-red-600" title="åˆ é™¤"><i class="fa fa-trash"></i></button>
                    </div>
                `;
                // ç‚¹å‡»è·³è½¬åˆ°è¯¥æ—¶é—´
                div.addEventListener('click', e => {
                    if (!e.target.closest('button')) {
                        videoPlayer.currentTime = item.time;
                        videoPlayer.play();
                        // é«˜äº®
                        document.querySelectorAll('#tsList > div').forEach(el => el.classList.remove('ring-2', 'ring-primary'));
                        div.classList.add('ring-2', 'ring-primary');
                        setTimeout(() => div.classList.remove('ring-2', 'ring-primary'), 3000);
                    }
                });
                // ç¼–è¾‘
                div.querySelector('.edit-ts').addEventListener('click', e => {
                    e.stopPropagation();
                    videoPlayer.currentTime = item.time;
                    tsTime.value = item.formatTime;
                    tsDesc.value = item.desc;
                    openTsModal();
                    // é‡å†™ä¿å­˜äº‹ä»¶
                    const originalSave = saveTs.onclick;
                    saveTs.onclick = () => {
                        tsData = tsData.filter(t => t.id !== item.id);
                        saveTimestamp();
                        saveTs.onclick = originalSave;
                    };
                });
                // åˆ é™¤
                div.querySelector('.del-ts').addEventListener('click', e => {
                    e.stopPropagation();
                    tsData = tsData.filter(t => t.id !== item.id);
                    renderTsList();
                });
                tsList.appendChild(div);
            });
            tsCount.textContent = tsData.length;
        }

        // å¯¼å‡ºæ—¶é—´æˆ³
        function exportTimestamp() {
            if (tsData.length === 0) return alert('æš‚æ— æ—¶é—´æˆ³å¯å¯¼å‡º');
            let content = tsData.map(item => `${item.formatTime}|${item.desc}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = videoFile.files[0] ? `${videoFile.files[0].name.replace(/\.\w+$/, '')}_æ—¶é—´æˆ³.txt` : 'è§†é¢‘æ—¶é—´æˆ³.txt';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // æ¸…ç©ºæ—¶é—´æˆ³
        function clearAllTimestamp() {
            if (tsData.length === 0) return;
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ—¶é—´æˆ³ï¼Ÿ')) {
                tsData = [];
                renderTsList();
            }
        }

        // ========== è¯­éŸ³è¯†åˆ«æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¿®å¤åï¼‰ ==========
        function initSpeechRecog() {
            if (!recognition) {
                recogStatus.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒï¼è¯·ç”¨Chrome/Edge';
                return;
            }
            // è¯†åˆ«é…ç½®ï¼ˆä¸­æ–‡ã€è¿ç»­è¯†åˆ«ã€æ˜¾ç¤ºä¸´æ—¶ç»“æœï¼‰
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true;
            // è¯†åˆ«ç»“æœå›è°ƒ
            recognition.onresult = e => {
                let tempText = '';
                // éå†ç»“æœï¼šfinalæ˜¯ç¡®å®šç»“æœï¼Œéfinalæ˜¯ä¸´æ—¶ç»“æœ
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    if (e.results[i].isFinal) finalText += e.results[i][0].transcript + ' ';
                    else tempText += e.results[i][0].transcript;
                }
                // æ›´æ–°æ–‡æœ¬æ¡†
                speechText.value = finalText + tempText;
                updateCharCount();
            };
            // è¯†åˆ«å¼€å§‹
            recognition.onstart = () => {
                isRecogRunning = true;
                recogStatus.textContent = 'ğŸ”Š æ­£åœ¨è¯†åˆ«ä¸­ï¼ˆè¯·å¤–æ”¾è§†é¢‘å£°éŸ³ï¼‰';
                // å¯ç”¨å¯¼å‡º/æ¸…ç©ºæŒ‰é’®
                [exportWord, clearText].forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
                // æŒ‰é’®æ ·å¼åˆ‡æ¢
                toggleRecog.innerHTML = '<i class="fa fa-stop"></i>åœæ­¢è¯­éŸ³è¯†åˆ«';
                toggleRecog.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleRecog.classList.add('bg-red-600', 'hover:bg-red-700');
            };
            // è¯†åˆ«ç»“æŸ/é”™è¯¯ï¼šè‡ªåŠ¨é‡å¯ï¼ˆä¿æŒè¿ç»­è¯†åˆ«ï¼‰
            recognition.onend = () => {
                if (isRecogRunning) setTimeout(() => recognition.start(), 100);
                else {
                    recogStatus.textContent = 'âœ… è¯†åˆ«å·²åœæ­¢';
                    toggleRecog.innerHTML = '<i class="fa fa-microphone"></i>å¯åŠ¨è¯­éŸ³è¯†åˆ«';
                    toggleRecog.classList.remove('bg-red-600', 'hover:bg-red-700');
                    toggleRecog.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            };
            // è¯†åˆ«é”™è¯¯æç¤º
            recognition.onerror = e => {
                let msg = 'è¯†åˆ«é”™è¯¯ï¼š';
                switch (e.error) {
                    case 'not-allowed': msg += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸'; break;
                    case 'no-speech': msg += 'æœªæ£€æµ‹åˆ°å£°éŸ³ï¼Œè¯·å¤–æ”¾è§†é¢‘å¹¶è°ƒå¤§éŸ³é‡'; break;
                    default: msg += e.error;
                }
                recogStatus.textContent = `âŒ ${msg}`;
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š', e);
            };
        }

        // åˆ‡æ¢è¯­éŸ³è¯†åˆ«å¯åœ
        function switchRecog() {
            if (!isRecogRunning) {
                // å¯åŠ¨ï¼šå…ˆèµ‹å€¼å½“å‰æ–‡æœ¬æ¡†å†…å®¹ï¼ˆé¿å…æ‰‹åŠ¨ç¼–è¾‘åä¸¢å¤±ï¼‰
                finalText = speechText.value.trim();
                try {
                    recognition.start();
                } catch (err) {
                    alert('å¯åŠ¨å¤±è´¥ï¼šè¯·æ£€æŸ¥éº¦å…‹é£æƒé™æˆ–æµè§ˆå™¨ç‰ˆæœ¬');
                    recogStatus.textContent = 'âŒ å¯åŠ¨å¤±è´¥ï¼š' + err.message;
                }
            } else {
                // åœæ­¢
                isRecogRunning = false;
                recognition.stop();
            }
        }

        // å¯¼å‡ºæ–‡å­—ä¸ºWord
        function exportToWord() {
            const text = speechText.value.trim();
            if (!text) return alert('æš‚æ— æ–‡å­—å¯å¯¼å‡º');
            // æ„å»ºWordçš„HTMLå†…å®¹ï¼ˆé€‚é…å®‹ä½“ï¼‰
            const html = `
                <html>
                <head><meta charset="UTF-8"><style>body{font-family:SimSun,å®‹ä½“;font-size:14px;line-height:1.8;}</style></head>
                <body>${text.replace(/\n/g, '<br>')}</body>
                </html>
            `;
            try {
                const blob = htmlDocx.asBlob(html);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = videoFile.files[0] ? `${videoFile.files[0].name.replace(/\.\w+$/, '')}_è¯­éŸ³æ–‡å­—.docx` : 'è§†é¢‘è¯­éŸ³æ–‡å­—.docx';
                a.click();
                URL.revokeObjectURL(a.href);
            } catch (err) {
                alert('å¯¼å‡ºWordå¤±è´¥ï¼š' + err.message);
            }
        }

        // æ¸…ç©ºè¯­éŸ³æ–‡å­—
        function clearSpeechText() {
            if (!speechText.value.trim()) return;
            if (confirm('ç¡®å®šæ¸…ç©ºè¯­éŸ³æ–‡å­—ï¼Ÿ')) {
                speechText.value = '';
                finalText = '';
                updateCharCount();
            }
        }

        // æ›´æ–°å­—ç¬¦æ•°
        function updateCharCount() {
            charCount.textContent = speechText.value.length;
        }
    </script>
</body>
</html>
